import React, { useEffect, useState, useMemo } from "react";
import MaterialReactTable from "material-react-table";
import { MenuItem, TextField, Autocomplete, Box, Typography } from "@mui/material";
import axios from "axios";

// Profile Type & Business Unit Options
const ProfileTypeOptions = ["Provider", "Consumer", "Both", "Inheritor"];
const BusinessUnitOptions = ["ABC", "UIO", "POA", "SKA-C"];

const CSFScopeTable = () => {
  const [tableData, setTableData] = useState([]);

  // Fetch Data from API
  useEffect(() => {
    const fetchData = async () => {
      try {
        const response = await axios.get("/api/ScopeData");
        const groupedData = Object.values(
          response.data.reduce((acc, item) => {
            if (!acc[item.subcategoryId]) {
              acc[item.subcategoryId] = {
                subcategoryId: item.subcategoryId,
                subcategoryName: item.subcategoryName,
                subcategoryDescription: item.subcategoryDescription,
                relatedSubcategories: item.relatedCsf1_1Subcategories,
                businessUnits: [],
              };
            }
            acc[item.subcategoryId].businessUnits.push(item);
            return acc;
          }, {})
        );
        setTableData(groupedData);
      } catch (error) {
        console.error("Error fetching scope data:", error);
      }
    };
    fetchData();
  }, []);

  // **L1: Subcategory Level (FILTERS WORKING CORRECTLY)**
  const subcategoryColumns = useMemo(() => [
    { accessorKey: "subcategoryName", header: "Subcategory", size: 120 },
    {
      accessorKey: "subcategoryDescription",
      header: "Description",
      size: 300,
      Cell: ({ cell }) => (
        <div style={{ whiteSpace: "normal", wordWrap: "break-word", overflowWrap: "break-word" }}>
          {cell.getValue()}
        </div>
      ),
    },
    { accessorKey: "relatedSubcategories", header: "Related Subcategories" },
    {
      accessorKey: "businessUnitAbbr",
      header: "BU",
      filterVariant: "multi-select",
      filterSelectOptions: BusinessUnitOptions,
      accessorFn: (row) => row.businessUnits.map((bu) => bu.businessUnitAbbr).join(", "),
    },
    {
      accessorKey: "businessUnitOwner",
      header: "BU Owner",
      filterVariant: "multi-select",
      filterSelectOptions: [...new Set(tableData.flatMap((row) => row.businessUnits.map((bu) => bu.businessUnitOwner)))],
      accessorFn: (row) => row.businessUnits.map((bu) => bu.businessUnitOwner).join(", "),
    },
    {
      accessorKey: "auditorIsInScope",
      header: "In Scope?",
      filterVariant: "multi-select",
      filterSelectOptions: ["Yes", "No"],
      accessorFn: (row) => row.businessUnits.map((bu) => bu.auditorIsInScope).join(", "),
    },
  ], [tableData]);

  return (
    <MaterialReactTable
      columns={subcategoryColumns}
      data={tableData}
      enableEditing={false} // L1 is NOT editable
      filterFromLeafRows={true} // ✅ FIXES FILTERING ISSUE ✅
      renderDetailPanel={({ row }) => (
        <MaterialReactTable
          columns={[
            { accessorKey: "businessUnitAbbr", header: "BU", enableEditing: false },
            { accessorKey: "businessUnitOwner", header: "BU Owner" },
            { accessorKey: "auditorIsInScope", header: "In Scope?" },
          ]}
          data={row.original.businessUnits}
          enableEditing
          editDisplayMode="row"
          muiTableContainerProps={{ sx: { overflowX: "auto" }}}
        />
      )}
    />
  );
};

export default CSFScopeTable;
