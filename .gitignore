import React, { useEffect, useState, useMemo } from "react";
import MaterialReactTable from "material-react-table";
import { MenuItem, TextField, Autocomplete, Box, Typography, Button, Stack } from "@mui/material";
import axios from "axios";

// Profile Type & Business Unit Options
const ProfileTypeOptions = ["Provider", "Consumer", "Both", "Inheritor"];
const BusinessUnitOptions = ["ABC", "UIO", "POA", "SKA-C"];

const CSFScopeTable = () => {
  const [tableData, setTableData] = useState([]);
  const [selectedBU, setSelectedBU] = useState([]); // For filtering at L1
  const [selectedBUOwner, setSelectedBUOwner] = useState([]);
  const [selectedInScope, setSelectedInScope] = useState([]);

  // Fetch Data from API
  useEffect(() => {
    const fetchData = async () => {
      try {
        const response = await axios.get("/api/ScopeData");
        const groupedData = Object.values(
          response.data.reduce((acc, item) => {
            if (!acc[item.subcategoryId]) {
              acc[item.subcategoryId] = {
                subcategoryId: item.subcategoryId,
                subcategoryName: item.subcategoryName,
                subcategoryDescription: item.subcategoryDescription,
                relatedSubcategories: item.relatedCsf1_1Subcategories,
                businessUnits: [],
              };
            }
            acc[item.subcategoryId].businessUnits.push(item);
            return acc;
          }, {})
        );
        setTableData(groupedData);
      } catch (error) {
        console.error("Error fetching scope data:", error);
      }
    };
    fetchData();
  }, []);

  // Fetch Worker Names API
  const fetchWorkerNames = async (inputValue) => {
    if (!inputValue.includes(" ")) return [];
    const [firstName, lastName] = inputValue.split(" ");
    
    try {
      const response = await axios.get(`/api/GetWorkerName`, {
        params: { FirstName: firstName, LastName: lastName }
      });
      return response.data.map(worker => ({
        label: `${worker.Namefull} (${worker.JobTitle})`,
        value: worker.Namefull,
      }));
    } catch (error) {
      console.error("Error fetching worker names:", error);
      return [];
    }
  };

  // Handle Row Save
  const handleSaveRow = ({ row, values, exitEditingMode }) => {
    const updatedData = [...tableData];
    const subcategoryIndex = updatedData.findIndex(
      (subcategory) => subcategory.subcategoryId === row.original.subcategoryId
    );
    const businessUnitIndex = updatedData[subcategoryIndex].businessUnits.findIndex(
      (bu) => bu.businessUnitAbbr === row.original.businessUnitAbbr
    );
    updatedData[subcategoryIndex].businessUnits[businessUnitIndex] = values;
    setTableData(updatedData);
    exitEditingMode();
  };

  // **Layer 1: Subcategory Level with Filtering**
  const subcategoryColumns = useMemo(() => [
    {
      accessorKey: "subcategoryName",
      header: "Subcategory",
      size: 120,
      filterVariant: "multi-select",
      filterSelectOptions: [...new Set(tableData.map((row) => row.subcategoryName))],
    },
    {
      accessorKey: "subcategoryDescription",
      header: "Description",
      size: 300,
      Cell: ({ cell }) => (
        <div style={{ whiteSpace: "normal", wordWrap: "break-word", overflowWrap: "break-word" }}>
          {cell.getValue()}
        </div>
      ),
    },
    { accessorKey: "relatedSubcategories", header: "Related Subcategories" },
    {
      accessorKey: "businessUnitAbbr",
      header: "BU",
      filterVariant: "multi-select",
      filterSelectOptions: BusinessUnitOptions,
    },
    {
      accessorKey: "businessUnitOwner",
      header: "BU Owner",
      filterVariant: "multi-select",
      filterSelectOptions: [...new Set(tableData.flatMap((row) => row.businessUnits.map((bu) => bu.businessUnitOwner)))],
    },
    {
      accessorKey: "auditorIsInScope",
      header: "In Scope?",
      filterVariant: "multi-select",
      filterSelectOptions: ["Yes", "No"],
    },
  ], [tableData]);

  // **Layer 2: Business Unit Level**
  const businessUnitColumns = useMemo(() => [
    { accessorKey: "businessUnitAbbr", header: "BU", enableEditing: false },
    {
      accessorKey: "businessUnitOwner",
      header: "BU Owner",
      Edit: ({ cell }) => (
        <Autocomplete
          multiple
          options={[]} 
          defaultValue={cell.getValue() ? cell.getValue().split(", ") : []}
          onInputChange={async (event, newValue) => {
            const results = await fetchWorkerNames(newValue);
            cell.setValue(results.map(res => res.value).join(", "));
          }}
          renderInput={(params) => <TextField {...params} label="Search Owners (First Last)" />}
        />
      ),
    },
    {
      accessorKey: "auditorSubcatCustodian",
      header: "Auditor Custodian",
      Edit: ({ cell }) => (
        <Autocomplete
          multiple
          options={[]} 
          defaultValue={cell.getValue() ? cell.getValue().split(", ") : []}
          onInputChange={async (event, newValue) => {
            const results = await fetchWorkerNames(newValue);
            cell.setValue(results.map(res => res.value).join(", "));
          }}
          renderInput={(params) => <TextField {...params} label="Search Custodians (First Last)" />}
        />
      ),
    },
    {
      accessorKey: "auditorProfileType",
      header: "Profile Type",
      Edit: ({ cell }) => (
        <TextField
          select
          value={cell.getValue() || ""}
          onChange={(event) => {
            const newValue = event.target.value;
            cell.setValue(newValue);
            if (!["Consumer", "Both"].includes(newValue)) {
              cell.row.getCell("auditorConsumingFromBusinessUnit").setValue("");
            }
          }}
        >
          {ProfileTypeOptions.map((option) => (
            <MenuItem key={option} value={option}>
              {option}
            </MenuItem>
          ))}
        </TextField>
      ),
    },
    {
      accessorKey: "auditorConsumingFromBusinessUnit",
      header: "Consuming From BU",
      Edit: ({ cell, row }) => (
        <TextField
          select
          value={cell.getValue() || ""}
          onChange={(event) => cell.setValue(event.target.value)}
          disabled={!["Consumer", "Both"].includes(row.getValue("auditorProfileType"))}
        >
          {BusinessUnitOptions.map((option) => (
            <MenuItem key={option} value={option}>
              {option}
            </MenuItem>
          ))}
        </TextField>
      ),
    },
  ], []);

  return (
    <MaterialReactTable
      columns={subcategoryColumns}
      data={tableData.filter(subcat => 
        (selectedBU.length === 0 || subcat.businessUnits.some(bu => selectedBU.includes(bu.businessUnitAbbr))) &&
        (selectedBUOwner.length === 0 || subcat.businessUnits.some(bu => selectedBUOwner.includes(bu.businessUnitOwner))) &&
        (selectedInScope.length === 0 || subcat.businessUnits.some(bu => selectedInScope.includes(bu.auditorIsInScope)))
      )}
      enableEditing
      editDisplayMode="row"
      renderDetailPanel={({ row }) => (
        <MaterialReactTable
          columns={businessUnitColumns}
          data={row.original.businessUnits.filter(bu => selectedBU.length === 0 || selectedBU.includes(bu.businessUnitAbbr))}
        />
      )}
    />
  );
};

export default CSFScopeTable;
