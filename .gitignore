import React, { useState, useEffect, useCallback, useMemo } from "react";
import axios from "axios";
import {
  Accordion,
  AccordionSummary,
  Typography,
  FormControl,
  Select,
  MenuItem,
  Grid,
  TextField,
  Autocomplete,
  TextField as MUITextField,
} from "@mui/material";
import { ExpandMore } from "@mui/icons-material";
import { DataGrid } from "@mui/x-data-grid";

// ✅ Fetch Data via Axios (Fast & Secure)
const fetchCSFScopeData = async () => {
  try {
    const response = await axios.get("/api/v1/GetCSFScopeData", {
      headers: { "Content-Type": "application/json" },
    });
    return Array.isArray(response.data) ? response.data : [];
  } catch (error) {
    console.error("Error fetching CSF Scope data:", error);
    return [];
  }
};

const CSFScopeTable = () => {
  const [scopeData, setScopeData] = useState([]);
  const [filteredSubcategories, setFilteredSubcategories] = useState([]);
  const [selectedSubcategories, setSelectedSubcategories] = useState([]);
  const [expandedSubcategories, setExpandedSubcategories] = useState({});
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    let isMounted = true;
    fetchCSFScopeData().then((data) => {
      if (isMounted) {
        const formattedData = formatScopeData(data);
        setScopeData(formattedData);
        setFilteredSubcategories(formattedData); // Default: Show all subcategories
        setLoading(false);
      }
    });
    return () => (isMounted = false);
  }, []);

  // ✅ Transform API response into grouped format
  const formatScopeData = useCallback((data) => {
    const groupedSubcategories = {};
    data.forEach((item) => {
      if (!groupedSubcategories[item.subcategoryId]) {
        groupedSubcategories[item.subcategoryId] = {
          id: `subcat-${item.subcategoryId}`,
          subcategoryId: item.subcategoryId,
          subcategoryName: item.subcategoryName,
          subcategoryDescription: item.subcategoryDescription,
          businessUnitOwner: item.businessUnitOwner,
          businessUnits: [],
        };
      }
      groupedSubcategories[item.subcategoryId].businessUnits.push({
        ...item,
        id: `${item.subcategoryId}-${item.businessUnitAbbreviation}`,
      });
    });

    return Object.values(groupedSubcategories);
  }, []);

  // ✅ Handle Multi-Select Filter for Subcategories
  const handleSubcategoryFilter = (event, selectedOptions) => {
    setSelectedSubcategories(selectedOptions);
    if (selectedOptions.length === 0) {
      setFilteredSubcategories(scopeData); // Show all if none selected
    } else {
      setFilteredSubcategories(
        scopeData.filter((subcategory) =>
          selectedOptions.includes(subcategory.subcategoryName)
        )
      );
    }
  };

  // ✅ Toggle Accordion Expansion
  const toggleAccordion = (subcategoryId) => {
    setExpandedSubcategories((prev) => ({
      ...prev,
      [subcategoryId]: !prev[subcategoryId],
    }));
  };

  // ✅ Business Unit DataGrid Columns
  const getBusinessUnitColumns = (businessUnits) => [
    { field: "businessUnitAbbreviation", headerName: "BU Abbr", width: 120 },
    { field: "auditorSubcatCustodian", headerName: "Auditor Custodian", width: 200 },
    {
      field: "auditorIsInScope",
      headerName: "Auditor - In Scope?",
      width: 150,
      renderCell: (params) => (
        <FormControl fullWidth>
          <Select
            value={params.value || ""}
            onChange={(e) => (params.row.auditorIsInScope = e.target.value)}
            variant="standard"
          >
            <MenuItem value="Yes">Yes</MenuItem>
            <MenuItem value="No">No</MenuItem>
          </Select>
        </FormControl>
      ),
    },
    {
      field: "subcatOwnerAcceptRecommendation",
      headerName: "Owner - Accept Recommendation?",
      width: 180,
      renderCell: (params) => (
        <FormControl fullWidth>
          <Select
            value={params.value || ""}
            onChange={(e) =>
              (params.row.subcatOwnerAcceptRecommendation = e.target.value)
            }
            variant="standard"
          >
            <MenuItem value="Yes">Yes</MenuItem>
            <MenuItem value="No">No</MenuItem>
          </Select>
        </FormControl>
      ),
    },
  ];

  return (
    <div>
      <Typography variant="h5" gutterBottom>
        CSF Scope Data
      </Typography>

      {/* ✅ Multi-Select Filter for Subcategories */}
      <Autocomplete
        multiple
        options={scopeData.map((subcat) => subcat.subcategoryName)}
        value={selectedSubcategories}
        onChange={handleSubcategoryFilter}
        renderInput={(params) => (
          <MUITextField
            {...params}
            variant="outlined"
            label="Filter by Subcategory"
            placeholder="Select Subcategories"
          />
        )}
        style={{ marginBottom: "20px", width: "50%" }}
      />

      {loading ? (
        <Typography>Loading data...</Typography>
      ) : (
        filteredSubcategories.map((subcategory) => (
          <Accordion key={subcategory.id} expanded={expandedSubcategories[subcategory.id]}>
            <AccordionSummary expandIcon={<ExpandMore />}>
              <Grid container spacing={2}>
                <Grid item xs={4}>
                  <Typography variant="h6">{subcategory.subcategoryName}</Typography>
                </Grid>
                <Grid item xs={4}>
                  <Typography variant="body2">{subcategory.subcategoryDescription}</Typography>
                </Grid>
                <Grid item xs={4}>
                  <Typography variant="body2">
                    <b>Owner:</b> {subcategory.businessUnitOwner}
                  </Typography>
                </Grid>
              </Grid>
            </AccordionSummary>
            <DataGrid
              rows={subcategory.businessUnits}
              columns={getBusinessUnitColumns(subcategory.businessUnits)}
              pageSize={5}
              autoHeight
            />
          </Accordion>
        ))
      )}
    </div>
  );
};

export default CSFScopeTable;
