import React, { useState, useEffect, useCallback } from "react";
import axios from "axios";
import {
  Accordion,
  AccordionSummary,
  Typography,
  FormControl,
  Select,
  MenuItem,
  Grid,
  TextField,
} from "@mui/material";
import { ExpandMore } from "@mui/icons-material";
import { DataGrid } from "@mui/x-data-grid";

// ✅ Fetch Data via Axios (Fast & Secure)
const fetchCSFScopeData = async () => {
  try {
    const response = await axios.get("/api/v1/GetCSFScopeData", {
      headers: { "Content-Type": "application/json" },
    });
    return Array.isArray(response.data) ? response.data : [];
  } catch (error) {
    console.error("Error fetching CSF Scope data:", error);
    return [];
  }
};

const CSFScopeTable = () => {
  const [scopeData, setScopeData] = useState([]);
  const [expandedSubcategories, setExpandedSubcategories] = useState({});
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    let isMounted = true;
    fetchCSFScopeData().then((data) => {
      if (isMounted) {
        setScopeData(formatScopeData(data));
        setLoading(false);
      }
    });
    return () => (isMounted = false);
  }, []);

  // ✅ Transform API response into grouped format for rendering
  const formatScopeData = useCallback((data) => {
    const groupedSubcategories = {};
    data.forEach((item) => {
      if (!groupedSubcategories[item.subcategoryId]) {
        groupedSubcategories[item.subcategoryId] = {
          id: `subcat-${item.subcategoryId}`,
          subcategoryId: item.subcategoryId,
          subcategoryName: item.subcategoryName,
          subcategoryDescription: item.subcategoryDescription,
          businessUnitOwner: item.businessUnitOwner,
          businessUnits: [],
        };
      }
      groupedSubcategories[item.subcategoryId].businessUnits.push({
        ...item,
        id: `${item.subcategoryId}-${item.businessUnitAbbreviation}`,
      });
    });

    return Object.values(groupedSubcategories);
  }, []);

  // ✅ Toggle Accordion Expansion
  const toggleAccordion = (subcategoryId) => {
    setExpandedSubcategories((prev) => ({
      ...prev,
      [subcategoryId]: !prev[subcategoryId],
    }));
  };

  // ✅ Columns for Business Unit DataGrid
  const getBusinessUnitColumns = (businessUnits) => [
    { field: "businessUnitAbbreviation", headerName: "BU Abbr", width: 120 },
    { field: "auditorSubcatCustodian", headerName: "Auditor Custodian", width: 200 },
    {
      field: "auditorIsInScope",
      headerName: "Auditor - In Scope?",
      width: 150,
      renderCell: (params) => (
        <FormControl fullWidth>
          <Select
            value={params.value || ""}
            onChange={(e) => (params.row.auditorIsInScope = e.target.value)}
            variant="standard"
          >
            <MenuItem value="Yes">Yes</MenuItem>
            <MenuItem value="No">No</MenuItem>
          </Select>
        </FormControl>
      ),
    },
    {
      field: "auditorJustification",
      headerName: "Justification",
      width: 250,
      renderCell: (params) =>
        params.row.auditorIsInScope === "No" ? (
          <TextField defaultValue={params.value} fullWidth variant="standard" />
        ) : null,
    },
    {
      field: "auditorProfileType",
      headerName: "Auditor Profile",
      width: 200,
      renderCell: (params) => (
        <FormControl fullWidth>
          <Select
            value={params.value || ""}
            onChange={(e) => (params.row.auditorProfileType = e.target.value)}
            variant="standard"
          >
            <MenuItem value="Provider">Provider</MenuItem>
            <MenuItem value="Consumer">Consumer</MenuItem>
            <MenuItem value="Inheritor">Inheritor</MenuItem>
            <MenuItem value="Both">Both</MenuItem>
          </Select>
        </FormControl>
      ),
    },
    {
      field: "auditorConsumingFromBusinessUnit",
      headerName: "Consuming From",
      width: 180,
      renderCell: (params) =>
        params.row.auditorProfileType === "Consumer" ||
        params.row.auditorProfileType === "Both" ? (
          <FormControl fullWidth>
            <Select defaultValue={params.value} variant="standard">
              {businessUnits.map((bu) => (
                <MenuItem key={bu.businessUnitAbbreviation} value={bu.businessUnitAbbreviation}>
                  {bu.businessUnitAbbreviation}
                </MenuItem>
              ))}
            </Select>
          </FormControl>
        ) : null,
    },
    {
      field: "subcatOwnerAcceptRecommendation",
      headerName: "Owner - Accept Recommendation?",
      width: 180,
      renderCell: (params) => (
        <FormControl fullWidth>
          <Select
            value={params.value || ""}
            onChange={(e) => (params.row.subcatOwnerAcceptRecommendation = e.target.value)}
            variant="standard"
          >
            <MenuItem value="Yes">Yes</MenuItem>
            <MenuItem value="No">No</MenuItem>
          </Select>
        </FormControl>
      ),
    },
    {
      field: "subcatOwnerJustification",
      headerName: "Owner Justification",
      width: 250,
      renderCell: (params) =>
        params.row.subcatOwnerAcceptRecommendation === "No" ? (
          <TextField defaultValue={params.value} fullWidth variant="standard" />
        ) : null,
    },
  ];

  return (
    <div>
      <Typography variant="h5" gutterBottom>
        CSF Scope Data
      </Typography>
      {loading ? (
        <Typography>Loading data...</Typography>
      ) : (
        scopeData.map((subcategory) => (
          <Accordion
            key={subcategory.id}
            expanded={expandedSubcategories[subcategory.id]}
            onChange={() => toggleAccordion(subcategory.id)}
          >
            <AccordionSummary expandIcon={<ExpandMore />}>
              <Grid container spacing={2} alignItems="center">
                <Grid item xs={3}>
                  <Typography variant="h6">{subcategory.subcategoryName}</Typography>
                </Grid>
                <Grid item xs={5}>
                  <Typography variant="body2">{subcategory.subcategoryDescription}</Typography>
                </Grid>
                <Grid item xs={4}>
                  <Typography variant="body2"><b>Owner:</b> {subcategory.businessUnitOwner}</Typography>
                </Grid>
              </Grid>
            </AccordionSummary>
            <DataGrid
              rows={subcategory.businessUnits}
              columns={getBusinessUnitColumns(subcategory.businessUnits)}
              pageSize={5}
              autoHeight
              disableSelectionOnClick
            />
          </Accordion>
        ))
      )}
    </div>
  );
};

export default CSFScopeTable;
