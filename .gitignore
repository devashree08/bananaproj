DECLARE @columns NVARCHAR(MAX),
        @sql NVARCHAR(MAX);

-- Build list of metric columns to unpivot
SELECT @columns = STRING_AGG(QUOTENAME(name), ',')
FROM sys.columns
WHERE object_id = OBJECT_ID('dbo.AllApps')
  AND name NOT IN ('AppId', 'ReportMonth');  -- exclude non-metrics

-- Construct dynamic SQL
SET @sql = '
SELECT 
    a.AppId,
    a.ReportMonth,
    unpvt.MetricName,
    unpvt.MetricValue,
    m.Status,
    m.MetricTextColor,
    m.MetricBackgroundColor
FROM 
    dbo.AllApps a
UNPIVOT (
    MetricValue FOR MetricName IN (' + @columns + ')
) AS unpvt
LEFT JOIN dbo.MetricMetadata m ON unpvt.MetricName = m.MetricName;
';

-- Execute dynamic SQL
EXEC sp_executesql @sql;
