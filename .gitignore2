SELECT 
    CAST(DATEADD(DAY, 1 - DAY(GETDATE()), GETDATE()) AS DATE) AS ReportMonth, -- First day of the current month
    a.AppID,
    b.BU,
    a.T1_Manager,
    a.T2_Manager,
    a.T3_Manager,
    COUNT(DISTINCT CASE WHEN ads.CVE_ID IN (SELECT VulnID FROM CVESummaryTable) 
        OR ads.CVE_ID = '' 
        OR (ads.VulnerabilityName LIKE '%amazon%' OR ads.VulnerabilityName LIKE '%open%' OR 
            ads.VulnerabilityName LIKE '%apache%' OR ads.VulnerabilityName LIKE '%debian%' OR 
            ads.VulnerabilityName LIKE '%node%' OR ads.VulnerabilityName LIKE '%smb%' OR 
            ads.VulnerabilityName LIKE '%rocky%' OR ads.VulnerabilityName LIKE '%ubuntu%' OR 
            ads.VulnerabilityName LIKE '%curl%' OR ads.VulnerabilityName LIKE '%azule%' OR 
            ads.VulnerabilityName LIKE '%centos%' OR ads.VulnerabilityName LIKE '%jboss%' OR 
            ads.VulnerabilityName LIKE '%php%' OR ads.VulnerabilityName LIKE '%python%' OR 
            ads.VulnerabilityName LIKE '%puppet%' OR ads.VulnerabilityName LIKE '%ssh%' OR 
            ads.VulnerabilityName LIKE '%ssl%' OR ads.VulnerabilityName LIKE '%tls%') 
        THEN ads.CVE_ID END) AS Total_TenableAgent,
    COUNT(DISTINCT CASE WHEN (ads.AgeDays > 90) AND 
        (ads.CVE_ID IN (SELECT VulnID FROM CVESummaryTable) 
        OR ads.CVE_ID = '' 
        OR (ads.VulnerabilityName LIKE '%amazon%' OR ads.VulnerabilityName LIKE '%open%' OR 
            ads.VulnerabilityName LIKE '%apache%' OR ads.VulnerabilityName LIKE '%debian%' OR 
            ads.VulnerabilityName LIKE '%node%' OR ads.VulnerabilityName LIKE '%smb%' OR 
            ads.VulnerabilityName LIKE '%rocky%' OR ads.VulnerabilityName LIKE '%ubuntu%' OR 
            ads.VulnerabilityName LIKE '%curl%' OR ads.VulnerabilityName LIKE '%azule%' OR 
            ads.VulnerabilityName LIKE '%centos%' OR ads.VulnerabilityName LIKE '%jboss%' OR 
            ads.VulnerabilityName LIKE '%php%' OR ads.VulnerabilityName LIKE '%python%' OR 
            ads.VulnerabilityName LIKE '%puppet%' OR ads.VulnerabilityName LIKE '%ssh%' OR 
            ads.VulnerabilityName LIKE '%ssl%' OR ads.VulnerabilityName LIKE '%tls%'))
        THEN ads.CVE_ID END) AS Overdue_TenableAgent,
    COUNT(DISTINCT a.AppID) AS CountApps,
    GETDATE() AS LastUpdateDate
FROM AllApps a  -- Start from AllApps to ensure only Level 1 apps
LEFT JOIN AgentDailySummary ads ON a.AppID = ads.AppID
LEFT JOIN BUMapping b ON a.T3_Manager = b.T3_Manager 
                   AND a.T2_Manager = b.T2_Manager 
                   AND a.T1_Manager = b.T1_Manager
WHERE a.RiskLevel = 'Level 1'
AND ads.Severity IN ('High', 'Critical')
GROUP BY a.AppID, b.BU, a.T1_Manager, a.T2_Manager, a.T3_Manager;
